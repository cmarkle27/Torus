<!DOCTYPE html> 
<html lang="en">

<head>
	<title>Tetris</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
	<script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.1.6/underscore-min.js"></script>
	<script src="http://ajax.cdnjs.com/ajax/libs/backbone.js/0.3.3/backbone-min.js"></script>
	<style type="text/css">
	body { background: #222; margin:0; padding:0; }
	canvas { background-image: url("img/space_bg.jpg"); border: solid 10px #000; float: left; }
	#wrapper { 
		margin: 40px auto; 
		width: 520px;
	}
	.clearfix { overflow: hidden; zoom: 1; }
	</style>
</head>
	
<body>
		
<div id="wrapper" class="clearfix">
	<canvas id="torusScreen" width="480" height="600"></canvas>
<button id="start">Start</button>
</div>


<script type="text/javascript">

// view stuff??? globals???
var canvas = document.getElementById("torusScreen");
var context = canvas.getContext("2d");
var tileSize = 40;
var tileImage = new Image();
tileImage.src = 'img/tile4.png';


var Tetrimino = Backbone.Model.extend({
 
	defaults : {
		"orientation" : 0,
		"altitude" : 0,
		"position" : 0
	},
	
	initialize : function() {
		//_.bindAll(this, "randomShape");
		this.set({"shape" : this.randomShape()});
		this.set({"color" : this.randomColor()});
		//this.bind('add', this.addOne);
	},

	// this could be a private method under initialize??? or be moved to module methods???
	randomShape : function() {
		var shapes = {
			j : new Array(
				{ "x" : [0, 1, 1, 1], "y" : [2, 2, 1, 0] },
				{ "x" : [0, 0, 1, 2], "y" : [0, 1, 1, 1] },
				{ "x" : [0, 0, 0, 1], "y" : [0, 1, 2, 0] },
				{ "x" : [0, 1, 2, 2], "y" : [0, 0, 0, 1] }
			)
			// i, o, l, s, z, t;
		};
		return shapes.j;//shapes[Math.floor(Math.random() * shapes.length)];
	},
	
	// this could be a private method under initialize???
	randomColor : function() {
		var colors = ["#cc0000", "#3399ff", "#ffff33", "#33cc00", "#666666", "#3333ff", "#339900", "#bbbbbb"];
		return colors[Math.floor(Math.random() * colors.length)];
	},
	
	// should this be a controller or view method???
	rotate : function(direction) {	
		var shape = this.get("shape");
		var orientation = this.get("orientation");
		
		if (direction === "left") {
			orientation++;
		} else {
			orientation--;
		}
		
		if (orientation === shape.length) {
			orientation = 0;
		} else if (orientation < 0) {
			orientation = shape.length - 1;
		}
		
		this.set({ "orientation" : orientation });
	},
	
	// should this be a controller or view method???
	move : function(direction) {	
		var shape = this.get("shape");
		var position = this.get("position");
		
		if (direction === "left") {
			position++;
		} else {
			position--;
		}
		
		console.log(position*tileSize)
		
/*
		if (position === shape.length) {
			position = 0;
		} else if (position < 0) {
			position = shape.length - 1;
		}
*/
		
		this.set({ "position" : position });
	},
	
	fall : function() {	
		var shape = this.get("shape");
		var altitude = this.get("altitude");
		
		altitude++; // or "depth"?
		
/*
		if (position === shape.length) {
			position = 0;
		} else if (position < 0) {
			position = shape.length - 1;
		}
*/
		
		this.set({ "altitude" : altitude });
	},
	
	
	url : function() {
		// Important! It's got to know where to send its REST calls.
		// In this case, POST to '/donuts' and PUT to '/donuts/:id'
		return this.id ? '/tetriminoes/' + this.id : '/tetriminoes';
	}
	
});

// ------------------------------------------------------------------------


TetriminoView = Backbone.View.extend({

    initialize : function(){
    	_.bindAll(this, "render", "onKeydown");
        this.render(); // render on init
        this.model.bind('change', this.render); // render on model change
        $(document).bind('keydown', this.onKeydown);
    },
    
    onKeydown : function(e) {
		switch (e.keyCode) {
			case 39: 
			case 68: 
				this.model.move("left");
			break;
					
			case 37: 
			case 65: 
				this.model.move("right");
			break;

			case 190: 
				this.model.rotate("left");
			break;
					
			case 188: 
				this.model.rotate("right");
			break;
				
/*
			case 38: 
			case 87: 
				toroid.push(.5);
			break; // up
			
			case 40: 
			case 83: 
				toroid.push(-.5);
			break; // down
*/
			
			default: 
				console.log(e.keyCode);
			break;
		}

    },
    
    render : function(){
    	
    	context.clearRect(0, 0, 480, 600); 
    	
		var shape = this.model.get("shape");
		var position = this.model.get("position");
		var orientation = this.model.get("orientation");
		var altitude = this.model.get("altitude");
		var color = this.model.get("color");
		var x = shape[orientation]["x"];
		var y = shape[orientation]["y"];
		var xCoord, yCoord;
				
		for (var i = 0; i < 4; i++) {
			
			xCoord = (x[i]*tileSize) + (position*tileSize);
			yCoord = (y[i]*tileSize) + (altitude*tileSize);
			
	     	context.beginPath();
	        context.rect(xCoord, yCoord, tileSize, tileSize);
	        context.fillStyle = color;
	        context.fill();
			
		    context.drawImage(tileImage, xCoord, yCoord, tileSize, tileSize);			

		}        
    }
    
        //events : arrows
    
});

// ------------------------------------------------------------------------







// GAMELOOP
function gameLoop(tetrimino) {

	tetrimino.fall();

	setTimeout(function() { gameLoop(tetrimino); }, 1000);


}


//console.log(bostonCream);


/*
var Tetriminoes = Backbone.Collection.extend({
  model : Tetrimino,
  url : "/tetriminoes"
});
*/


//var tetriminoes = new Tetriminoes();
 
//tetriminoes.fetch(); 
// this makes a call to the server and populates the collection based on the response.
// perhaps for saving to server

/*
tetriminoes.each(function(tetrimino) {
	console.log(tetrimino);
});
*/


// ------------------------------------------------------------------------

// view events (move to view?)

$(document).ready(function() {
	
	$('#start').on('click', function() {
	
		//window.board = new Board({ 'level' : level });
		// global for debugging only
		var activeTetrimino = new Tetrimino({ speed : 1000 });
		var activeTetriminoView = new TetriminoView({model: activeTetrimino});
		
		gameLoop(activeTetrimino);
		
		//$(this).html('Restart Game');

	});
	
});


    
</script>
</body>
	
</html>


